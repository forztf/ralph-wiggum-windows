# Ralph Wiggum 循环测试总结

## 测试概述

本文档记录了 Ralph Wiggum Windows 插件的完整测试过程和发现。

## 测试环境

- **日期：** 2026-01-07
- **平台：** Windows
- **Claude Code 版本：** 使用 Opus 4.5 模型
- **插件版本：** forztf/ralph-wiggum-windows

## 测试执行

### 循环 #1：2次迭代测试 ✅

**配置：**
- 最大迭代次数：2
- 完成承诺：TEST DONE
- 时间范围：16:43 - 16:50

**结果：** 成功完成

**关键发现：**
- ✅ 停止钩子正确触发了
- ✅ 状态文件正常更新
- ✅ 迭代计数准确递增
- ✅ 达到最大迭代后正确终止

### 循环 #2：5次迭代测试 🔄

**配置：**
- 最大迭代次数：5
- 完成承诺：TEST DONE
- 开始时间：16:57:16Z

**当前进度：** 3/5 迭代

## 核心发现

### 1. "自动启动"机制的真实工作原理

**误区澄清：**
- ❌ 不是创建新的独立会话
- ✅ 是在**同一会话中**阻止退出并继续工作

**工作流程：**
```
┌─────────────────────────────────────────────────────────────┐
│                     Ralph Wiggum 循环                        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  1. 用户尝试退出会话                                      │
│           ↓                                                  │
│  2. 停止钩子被触发                                       │
│           ↓                                                  │
│  3. 钩子读取 .claude/ralph-loop.local.md                  │
│           ↓                                                  │
│  4. 检查是否达到最大迭代次数                             │
│     ├─ 是 → 删除状态文件，允许退出                            │
│     └─ 否 → 继续                                           │
│           ↓                                                  │
│  5. 更新状态文件 (iteration: N → N+1)                        │
│           ↓                                                  │
│  6. 输出 JSON: {"decision":"block",...}                      │
│           ↓                                                  │
│  7. 在同一会话中继续工作 ✨                                │
│           ↓                                                  │
│  8. 下次退出时重复此流程                                  │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 2. 状态文件的作用

**文件：** `.claude/ralph-loop.local.md`

**格式：**
```markdown
---
active: true
iteration: 3
max_iterations: 5
completion_promise: "TEST DONE"
started_at: "2026-01-07T16:57:16Z"
---

原始提示文本...
```

**字段说明：**
- `active` - 循环是否活跃
- `iteration` - 当前迭代次数（自动递增）
- `max_iterations` - 最大迭代限制
- `completion_promise` - 完成承诺文本
- `started_at` - 循环开始时间戳

### 3. 停止钩子的 JSON 输出

**格式：**
```json
{
  "decision": "block",
  "reason": "原始提示文本",
  "systemMessage": "Ralph iteration 3 | To stop: output <promise>TEST DONE</promise>"
}
```

**字段含义：**
- `decision: "block"` - 阻止退出
- `reason` - 原始提示文本（用于继续）
- `systemMessage` - 系统消息（告知迭代状态）

## 使用建议

### 适用场景

✅ **推荐用于：**
- 明确定义的任务（有清晰成功标准）
- 需要多次迭代优化的开发
- 绿地项目（可以增量构建）
- 可测量的重构任务
- 测试覆盖率提升

❌ **不推荐用于：**
- 需要人类判断或设计决策的任务
- 一次性操作（正常使用 Claude 即可）
- 成功标准不清晰的任务
- 生产环境调试（需要人工监督）

### 最佳实践

1. **设置合理的最大迭代次数**
   - 避免无限循环
   - 根据任务复杂度估算

2. **使用明确的完成承诺**
   - 承诺文本必须可验证
   - Claude 只在真正完成时输出

3. **监控循环状态**
   ```powershell
   # 查看当前迭代
   Select-String '^iteration:' .claude/ralph-loop.local.md

   # 查看调试日志
   Get-Content .claude/ralph-debug.log -Tail 20
   ```

4. **必要时手动取消**
   ```powershell
   /ralph-wiggum-windows:cancel-ralph
   ```

## 已知限制

1. **依赖状态文件**
   - 状态文件损坏会导致循环终止
   - 文件格式必须正确

2. **传输文件要求**
   - 必须存在且格式正确（JSONL）
   - 必须包含有效的 assistant 消息

3. **完成承诺限制**
   - 文本必须完全匹配
   - 不支持模糊匹配或正则表达式

4. **性能考虑**
   - 大型传输文件可能影响解析性能
   - 长时间运行可能产生大量日志

## 总结

Ralph Wiggum Windows 插件成功实现了自引用迭代式 AI 开发循环。停止钩子机制工作正常，状态管理准确可靠。通过理解其"在同一会话中继续工作"的本质，可以更好地利用这一强大的开发工具。

---

**文档版本：** 1.0
**最后更新：** 2026-01-07
**测试者：** Claude Opus 4.5
